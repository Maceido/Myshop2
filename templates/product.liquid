<!-- PRODUCT PAGE LAYOUT -->
<section class="product-page">

  {%- assign initial_variant = product.selected_or_first_available_variant -%}

  <!-- LEFT COLUMN: GALLERY -->
  <div class="product-gallery">

    <!-- SIDE THUMBNAILS -->
    <div class="product-gallery-side" id="SideThumbs">
      <!-- JS will render based on variant -->
    </div>

    <!-- MAIN IMAGE -->
    <div class="product-gallery-main">
      <img 
        id="MainImage"
        class="product-main-image"
        src="{{ initial_variant.featured_media.preview_image.src | image_url: width: 1200 }}"
        alt="{{ product.title }}"
      >
    </div>

  </div>


  <!-- MIDDLE COLUMN -->
  <div class="product-main-info">

    <h1 class="product-title">{{ product.title }}</h1>

    <div class="product-rating-placeholder">★★★★☆ <span>Rating coming soon</span></div>

    <div class="product-price-main" id="PriceMain">
      {{ initial_variant.price | money }}
    </div>

    {%- assign option_count = product.options_with_values.size -%}

    <div class="product-selector">

      <!-- COLOR OPTION -->
      {% if option_count >= 1 %}
        {% assign color_opt = product.options_with_values[0] %}

        <div class="selector-block">
          <div class="selector-label-row">
            <div class="selector-label">
              Color: <span id="SelectedColor">{{ color_opt.selected_value }}</span>
            </div>
          </div>

          <div class="color-swatch-grid">
            {% for value in color_opt.values %}

              {% assign swatch_img = blank %}
              {% for v in product.variants %}
                {% if v.option1 == value and v.featured_media %}
                  {% assign swatch_img = v.featured_media.preview_image.src %}
                  {% break %}
                {% endif %}
              {% endfor %}

              <button 
                type="button"
                class="color-swatch{% if color_opt.selected_value == value %} is-active{% endif %}"
                data-option-index="0"
                data-option-value="{{ value }}"
              >
                {% if swatch_img %}
                  <img src="{{ swatch_img | img_url: '120x' }}">
                {% endif %}
                <span>{{ value }}</span>
              </button>

            {% endfor %}
          </div>
        </div>

      {% endif %}

      <!-- SIZE OPTION -->
      {% if option_count >= 2 %}
        {% assign size_opt = product.options_with_values[1] %}

        <div class="selector-block">
          <div class="selector-label-row">
            <div class="selector-label">
              Size: <span id="SelectedSize">{{ size_opt.selected_value }}</span>
            </div>

            <button type="button" class="size-chart-link" id="SizeChartButton">Size chart</button>
          </div>

          <div class="size-pill-grid">
            {% for value in size_opt.values %}
              <button 
                type="button"
                class="size-pill{% if size_opt.selected_value == value %} is-active{% endif %}"
                data-option-index="1"
                data-option-value="{{ value }}"
              >
                {{ value }}
              </button>
            {% endfor %}
          </div>
        </div>

      {% endif %}

    </div>

    <!-- PRODUCT DETAILS -->
    <div class="product-details-section">
      <h3>Product details</h3>
      <div class="product-details-content">
        {{ product.description 
          | replace: '<img', '<!--img'
          | replace: 'src=', 'Xsrc='
          | strip_html
        }}
      </div>
    </div>

    <div class="product-about-section">
      <h3>About this item</h3>
      <p>{{ product.title }} with multiple styles and sizes available.</p>
    </div>

  </div>


  <!-- RIGHT COLUMN -->
  <div class="product-buy-box">

    <div class="buy-box-price" id="BuyBoxPrice">
      {{ initial_variant.price | money }}
    </div>

    <div class="buy-box-delivery">
      Delivery shown at checkout
      <div class="buy-box-location">
        {% if customer and customer.default_address %}
          Delivering to {{ customer.default_address.city }}, {{ customer.default_address.zip }}
        {% else %}
          Set your delivery location above
        {% endif %}
      </div>
    </div>

    <div id="StockBox" class="buy-box-stock">
      {% if initial_variant.available %}In stock{% else %}Out of stock{% endif %}
    </div>

    {% form 'product', product, id: 'ProductForm' %}
      <input type="hidden" id="VariantIdInput" name="id" value="{{ initial_variant.id }}">

      <div class="buy-box-quantity">
        <label>Quantity:</label>
        <select id="QtySelect" name="quantity"></select>
      </div>

      <div class="buy-box-actions">
        <button class="btn btn-primary" type="submit">Add to Cart</button>
        <button class="btn btn-outline" id="BuyNowBtn" type="button">Buy Now</button>
      </div>

    {% endform %}
  </div>

</section>


<!-- FULLSCREEN IMAGE GALLERY -->
<div class="image-gallery-modal" id="ImageGalleryModal">
  <div class="image-gallery-backdrop"></div>
  <div class="image-gallery-content">
    <button id="ImageGalleryClose" class="image-gallery-close">×</button>
    <div class="image-gallery-carousel" id="ImageGalleryCarousel"></div>
  </div>
</div>

<!-- SIZE CHART -->
<div class="size-chart-modal" id="SizeChartModal">
  <div class="size-chart-backdrop"></div>
  <div class="size-chart-content">
    <button id="SizeChartClose" class="size-chart-close">×</button>
    <h3>Size Chart</h3>
    <div class="size-chart-grid">
      {{ product.metafields.specs.size_chart | metafield_text }}
    </div>
  </div>
</div>



<!-- JAVASCRIPT -->
<script>
document.addEventListener("DOMContentLoaded", function() {

  const product = {{ product | json }};
  let currentVariant = product.selected_or_first_available_variant || product.variants[0];
  let selectedOptions = currentVariant.options.slice();

  const mainImg = document.getElementById("MainImage");
  const thumbsContainer = document.getElementById("SideThumbs");
  const priceMain = document.getElementById("PriceMain");
  const priceBox = document.getElementById("BuyBoxPrice");
  const stockBox = document.getElementById("StockBox");
  const qtySelect = document.getElementById("QtySelect");
  const variantIdInput = document.getElementById("VariantIdInput");

  const galleryModal = document.getElementById("ImageGalleryModal");
  const galleryCarousel = document.getElementById("ImageGalleryCarousel");

  function clean(url) {
    return url ? url.split("?")[0] : "";
  }

  function moneyFormat(cents) {
    return (cents / 100).toLocaleString("en-US", { style: "currency", currency: "USD" });
  }

  /* FOCUS: ONLY VARIANT IMAGES */
  function getVariantImages(variant) {
    let media = [];

    if (variant.featured_media) {
      media.push(clean(variant.featured_media.preview_image.src));
    }

    product.media.forEach(m => {
      if (Array.isArray(m.variant_ids) && m.variant_ids.includes(variant.id)) {
        media.push(clean(m.src));
      }
    });

    // remove duplicates
    media = [...new Set(media)];

    // fallback if no variant images exist
    if (media.length === 0) {
      media = product.media.map(m => clean(m.src));
    }

    return media;
  }

  function renderThumbs(variant) {
    const images = getVariantImages(variant);
    thumbsContainer.innerHTML = "";

    images.slice(0, 5).forEach((src, index) => {
      thumbsContainer.innerHTML += `
        <button class="product-thumb ${index === 0 ? "is-active" : ""}" data-media-src="${src}">
          <img src="${src}" width="120">
        </button>
      `;
    });

    thumbsContainer.innerHTML += `
      <button class="product-thumb product-thumb-more"/>
        +${product.media.length - 0}
      </button>
    `;

    setMainImage(images[0]);
    attachThumbEvents();
  }

  function attachThumbEvents() {
    const thumbs = thumbsContainer.querySelectorAll(".product-thumb:not(.product-thumb-more)");

    thumbs.forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".product-thumb").forEach(x => x.classList.remove("is-active"));
        btn.classList.add("is-active");
        setMainImage(btn.dataset.mediaSrc);
      });
    });

    const more = thumbsContainer.querySelector(".product-thumb-more");
    if (more) {
      more.addEventListener("click", () => {
        galleryCarousel.innerHTML = "";
        product.media.forEach(m => {
          galleryCarousel.innerHTML += `<img class="gallery-big-image" src="${clean(m.src)}">`;
        });
        galleryModal.classList.add("is-open");
      });
    }
  }

  function setMainImage(src) {
    mainImg.src = clean(src);
  }

  function syncQty(v) {
    qtySelect.innerHTML = "";
    let max = v.inventory_management ? v.inventory_quantity : 50;
    max = Math.min(max, 50);
    if (max < 1) max = 1;

    for (let i = 1; i <= max; i++) {
      qtySelect.innerHTML += `<option value="${i}">${i}</option>`;
    }
  }

  function updateVariant() {
    currentVariant = product.variants.find(v =>
      JSON.stringify(v.options) === JSON.stringify(selectedOptions)
    ) || product.variants[0];

    priceMain.textContent = moneyFormat(currentVariant.price);
    priceBox.textContent = moneyFormat(currentVariant.price);

    stockBox.textContent = currentVariant.available ? "In stock" : "Out of stock";
    stockBox.style.color = currentVariant.available ? "#16a34a" : "#dc2626";

    variantIdInput.value = currentVariant.id;

    syncQty(currentVariant);
    renderThumbs(currentVariant);
  }

  // Color click
  document.querySelectorAll(".color-swatch").forEach(btn => {
    btn.addEventListener("click", () => {
      selectedOptions[0] = btn.dataset.optionValue;

      document.querySelectorAll(".color-swatch").forEach(x => x.classList.remove("is-active"));
      btn.classList.add("is-active");

      document.getElementById("SelectedColor").textContent = btn.dataset.optionValue;

      updateVariant();
    });
  });

  // Size click
  document.querySelectorAll(".size-pill").forEach(btn => {
    btn.addEventListener("click", () => {
      selectedOptions[1] = btn.dataset.optionValue;

      document.querySelectorAll(".size-pill").forEach(x => x.classList.remove("is-active"));
      btn.classList.add("is-active");

      document.getElementById("SelectedSize").textContent = btn.dataset.optionValue;

      updateVariant();
    });
  });

  // Close gallery
  document.getElementById("ImageGalleryClose").addEventListener("click", () => {
    galleryModal.classList.remove("is-open");
  });

  document.querySelector(".image-gallery-backdrop").addEventListener("click", () => {
    galleryModal.classList.remove("is-open");
  });

  // Size chart
  document.getElementById("SizeChartButton").addEventListener("click", () => {
    document.getElementById("SizeChartModal").classList.add("is-open");
  });

  document.getElementById("SizeChartClose").addEventListener("click", () => {
    document.getElementById("SizeChartModal").classList.remove("is-open");
  });

  document.querySelector(".size-chart-backdrop").addEventListener("click", () => {
    document.getElementById("SizeChartModal").classList.remove("is-open");
  });

  updateVariant();
});
</script>
