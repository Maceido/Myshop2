<!-- PRODUCT PAGE LAYOUT -->
<section class="product-page">

<div class="product-gallery">

  <!-- SIDE THUMBNAILS (DYNAMIC) -->
  <div class="product-gallery-side" id="SideThumbs">
    {% assign default_variant = product.selected_or_first_available_variant %}

    {% if default_variant.featured_media %}
      {% assign variant_media = default_variant.featured_media | media_image_url: width: 1200 %}
    {% endif %}

    {% comment %}
      Collect all media for this variant
    {% endcomment %}
    {% assign variant_media_list = "" %}
    {% for m in product.media %}
      {% if m.variant_ids contains default_variant.id %}
        {% assign variant_media_list = variant_media_list | append: m | append: ',' %}
      {% endif %}
    {% endfor %}

    {% assign variant_media_array = variant_media_list | split: ',' %}
    {% assign max_thumbs = 5 %}

    {% if variant_media_array.size > 1 %}
      {% for img in variant_media_array %}
        {% if forloop.index0 < max_thumbs %}
          <button 
            type="button"
            class="product-thumb{% if forloop.first %} is-active{% endif %}"
            data-media-src="{{ img | image_url: width: 1200 }}"
          >
            <img src="{{ img | image_url: width: 120 }}" alt="">
          </button>
        {% elsif forloop.index0 == max_thumbs %}
          <button type="button" class="product-thumb product-thumb-more" data-more="true">
            +{{ variant_media_array.size | minus: max_thumbs }}
          </button>
          {% break %}
        {% endif %}
      {% endfor %}
    {% else %}
      {% comment %} fallback: all media {% endcomment %}
      {% for media in product.media %}
        {% if forloop.index0 < max_thumbs %}
          <button 
            type="button"
            class="product-thumb{% if forloop.first %} is-active{% endif %}"
            data-media-src="{{ media | image_url: width: 1200 }}"
          >
            <img src="{{ media | image_url: width: 120 }}" alt="">
          </button>
        {% elsif forloop.index0 == max_thumbs %}
          <button type="button" class="product-thumb product-thumb-more" data-more="true">
            +{{ product.media.size | minus: max_thumbs }}
          </button>
          {% break %}
        {% endif %}
      {% endfor %}
    {% endif %}
  </div>

  <!-- MAIN IMAGE -->
  {% assign first_media = product.selected_or_first_available_variant.featured_media | default: product.media.first %}
  <div class="product-gallery-main">
    <img 
      id="MainImage"
      class="product-main-image"
      src="{{ first_media | image_url: width: 1200 }}"
      alt="{{ product.title }}"
    >
  </div>

</div>



  <!-- MIDDLE COLUMN: TITLE, OPTIONS, DETAILS -->
  <div class="product-main-info">

    <h1 class="product-title">{{ product.title }}</h1>

    <div class="product-rating-placeholder">
      ★★★★☆ <span>Rating coming soon</span>
    </div>

    <div class="product-price-main" id="PriceMain">
      {{ product.selected_or_first_available_variant.price | money }}
    </div>

    {% assign option_count = product.options_with_values.size %}

    <div class="product-selector">

      <!-- COLOR OPTION -->
      {% if option_count >= 1 %}
        {% assign color_opt = product.options_with_values[0] %}
        <div class="selector-block">
          <div class="selector-label-row">
            <div class="selector-label">
              Color:
              <span id="SelectedColor">{{ color_opt.selected_value }}</span>
            </div>
          </div>

          <div class="color-swatch-grid">
            {% for value in color_opt.values %}
              
              {% assign swatch_img = blank %}
              {% for v in product.variants %}
                {% if v.option1 == value and v.featured_media %}
                  {% assign swatch_img = v.featured_media.preview_image.src %}
                  {% break %}
                {% endif %}
              {% endfor %}

              <button 
                type="button"
                class="color-swatch{% if color_opt.selected_value == value %} is-active{% endif %}"
                data-option-index="0"
                data-option-value="{{ value | escape }}"
                data-media-src="{{ swatch_img }}"
              >
                {% if swatch_img %}
                  <img src="{{ swatch_img | img_url: '120x' }}">
                {% endif %}
                <span class="color-swatch-name">{{ value }}</span>
              </button>

            {% endfor %}
          </div>
        </div>
      {% endif %}

      <!-- SIZE OPTION -->
    {% if option_count >= 2 %}
    {% assign size_opt = product.options_with_values[1] %}
    {% else %}
    {% assign size_opt = blank %}
    {% endif %}

    {% if size_opt %}
    <div class="selector-block">
        <div class="selector-label-row">
        <div class="selector-label">
            Size:
            <span id="SelectedSize">{{ size_opt.selected_value }}</span>
        </div>

        <button type="button" class="size-chart-link" id="SizeChartButton">
            Size chart
        </button>
        </div>

        <div class="size-pill-grid">
        {% for value in size_opt.values %}
            <button
            type="button"
            class="size-pill{% if size_opt.selected_value == value %} is-active{% endif %}"
            data-option-index="1"
            data-option-value="{{ value }}"
            >
            {{ value }}
            </button>
        {% endfor %}
        </div>
    </div>
    {% endif %}



    <!-- PRODUCT DETAILS (NO IMAGES ALLOWED) -->
    <div class="product-details-section">
      <h3>Product details</h3>
      <div class="product-details-content">
        {{ product.description 
          | replace: '<img', '<!--img' 
          | replace: 'src=', 'Xsrc=' 
          | strip_html }}
      </div>
    </div>

    <div class="product-about-section">
      <h3>About this item</h3>
      <p>{{ product.title }} with multiple styles and sizes available.</p>
    </div>

  </div> <!-- END MIDDLE COLUMN -->


  <!-- RIGHT COLUMN: BUY BOX -->
  <div class="product-buy-box">

    <div class="buy-box-price" id="BuyBoxPrice">
      {{ product.selected_or_first_available_variant.price | money }}
    </div>

    <div class="buy-box-delivery">
      Delivery time shown at checkout
      <div class="buy-box-location">
        {% if customer and customer.default_address %}
          Delivering to {{ customer.default_address.city }}, {{ customer.default_address.zip }}
        {% else %}
          Set your delivery location above
        {% endif %}
      </div>
    </div>

    <div id="StockBox" class="buy-box-stock">
      {% if product.selected_or_first_available_variant.available %}
        In stock
      {% else %}
        Out of stock
      {% endif %}
    </div>

    {% form 'product', product, id: 'ProductForm' %}
      <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">

      <div class="buy-box-quantity">
        <label>Quantity:</label>
        <select id="QtySelect" name="quantity"></select>
      </div>

      <div class="buy-box-actions">
        <button class="btn btn-primary" type="submit">Add to Cart</button>
        <button class="btn btn-outline" id="BuyNowBtn" type="button">Buy Now</button>
      </div>

    {% endform %}

  </div>

</section>



<!-- FULLSCREEN IMAGE GALLERY -->
<div class="image-gallery-modal" id="ImageGalleryModal">
  <div class="image-gallery-backdrop"></div>
  <div class="image-gallery-content">
    <button id="ImageGalleryClose" class="image-gallery-close">×</button>

    <div class="image-gallery-carousel" id="ImageGalleryCarousel">
      {% for media in product.media %}
        <img src="{{ media | image_url: width: 1600 }}" class="gallery-big-image">
      {% endfor %}
    </div>
  </div>
</div>


<!-- SIZE CHART MODAL -->
<div class="size-chart-modal" id="SizeChartModal">
  <div class="size-chart-backdrop"></div>
  <div class="size-chart-content">
    <button id="SizeChartClose" class="size-chart-close">×</button>
    <h3>Size Chart</h3>
    <!-- SIZE CHART GRID (NO IMAGE REQUIRED) -->
    <div class="size-chart-grid">
    <table>
        <thead>
        <tr>
            <th>Size</th>
            <th>Chest (in)</th>
            <th>Chest (cm)</th>
            <th>Length (in)</th>
            <th>Length (cm)</th>
        </tr>
        </thead>

        <tbody>
        {% assign chart = product.metafields.specs.size_chart %}

        {% if chart %}
            {{ chart | metafield_text }}
        {% else %}
            <!-- FALLBACK AUTO GRID -->
            <tr><td>S</td><td>34–36</td><td>86–91</td><td>26</td><td>66</td></tr>
            <tr><td>M</td><td>38–40</td><td>96–102</td><td>27</td><td>68.5</td></tr>
            <tr><td>L</td><td>42–44</td><td>107–112</td><td>28</td><td>71</td></tr>
            <tr><td>XL</td><td>46–48</td><td>117–122</td><td>29</td><td>73.5</td></tr>
            <tr><td>XXL</td><td>50–52</td><td>127–132</td><td>30</td><td>76</td></tr>
        {% endif %}
        </tbody>
    </table>
    </div>
  </div>
</div>


<!-- JAVASCRIPT -->
<script>
document.addEventListener("DOMContentLoaded", () => {

  const product = {{ product | json }};
  let selectedOptions = product.variants[0].options.slice();

  const mainImg = document.getElementById("MainImage");
  const thumbs = document.querySelectorAll(".product-thumb:not([data-more])");
  const colorBtns = document.querySelectorAll(".color-swatch");
  const sizeBtns = document.querySelectorAll(".size-pill");

  /** Normalize URLs so Shopify stops lying */
  function clean(url) {
    return url ? url.split("?")[0] : "";
  }

  /** Swap main image */
  function setMain(src) {
    if (!src) return;
    mainImg.src = clean(src);
  }

  /** Find variant object */
  function findVariant() {
    return product.variants.find(v =>
      JSON.stringify(v.options) === JSON.stringify(selectedOptions)
    ) || product.variants[0];
  }

  /** Update variant = price, stock, image */
  function updateVariant() {
    const v = findVariant();
    if (!v) return;

    // Price
    document.getElementById("PriceMain").innerHTML =
      (v.price / 100).toLocaleString("en-US", { style: "currency", currency: "USD" });

    document.getElementById("BuyBoxPrice").innerHTML =
      (v.price / 100).toLocaleString("en-US", { style: "currency", currency: "USD" });

    // Stock
    const stock = document.getElementById("StockBox");
    if (v.available) {
      stock.textContent = "In stock";
      stock.style.color = "#16a34a";
    } else {
      stock.textContent = "Out of stock";
      stock.style.color = "#dc2626";
    }

    // Image
    if (v.featured_media) {
      setMain(v.featured_media.preview_image.src);
    }

    // Qty
    const qtySelect = document.getElementById("QtySelect");
    qtySelect.innerHTML = "";
    let max = v.inventory_management ? v.inventory_quantity : 50;
    if (max > 50) max = 50;
    if (max < 1) max = 1;
    for (let i = 1; i <= max; i++) {
      const o = document.createElement("option");
      o.value = i;
      o.textContent = i;
      qtySelect.appendChild(o);
    }
  }

  /** Thumbnail click */
  thumbs.forEach(btn => {
    btn.addEventListener("click", () => {
      setMain(btn.dataset.mediaSrc);
    });
  });

  /** Color click */
  colorBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      const idx = btn.dataset.optionIndex;
      const val = btn.dataset.optionValue;

      colorBtns.forEach(b => b.classList.remove("is-active"));
      btn.classList.add("is-active");

      document.getElementById("SelectedColor").textContent = val;
      selectedOptions[idx] = val;
      updateVariant();
    });
  });

  /** Size click */
  sizeBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      const idx = btn.dataset.optionIndex;
      const val = btn.dataset.optionValue;

      sizeBtns.forEach(b => b.classList.remove("is-active"));
      btn.classList.add("is-active");

      document.getElementById("SelectedSize").textContent = val;
      selectedOptions[idx] = val;
      updateVariant();
    });
  });

  /** MORE IMAGES → FULLSCREEN VIEWER */
  const moreBtn = document.querySelector(".product-thumb-more");
  const modal = document.getElementById("ImageGalleryModal");
  const closeModal = document.getElementById("ImageGalleryClose");
  const backdrop = document.querySelector(".image-gallery-backdrop");

  if (moreBtn) {
    moreBtn.addEventListener("click", () => modal.classList.add("is-open"));
  }
  if (closeModal) closeModal.addEventListener("click", () => modal.classList.remove("is-open"));
  if (backdrop) backdrop.addEventListener("click", () => modal.classList.remove("is-open"));

  /** BUY NOW */
  const buyNowBtn = document.getElementById("BuyNowBtn");
  buyNowBtn.addEventListener("click", () => {
    const v = findVariant();
    window.location.href = `/cart/${v.id}:1?checkout=true`;
  });

  /** SIZE CHART */
  const sizeBtn = document.getElementById("SizeChartButton");
  const sizeModal = document.getElementById("SizeChartModal");
  const sizeClose = document.getElementById("SizeChartClose");
  const sizeBackdrop = document.querySelector(".size-chart-backdrop");

  if (sizeBtn) sizeBtn.addEventListener("click", () => sizeModal.classList.add("is-open"));
  if (sizeClose) sizeClose.addEventListener("click", () => sizeModal.classList.remove("is-open"));
  if (sizeBackdrop) sizeBackdrop.addEventListener("click", () => sizeModal.classList.remove("is-open"));

  updateVariant();
});
</script>