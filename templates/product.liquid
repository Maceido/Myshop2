<section class="product-page">

  {% assign initial_variant = product.selected_or_first_available_variant %}
  {% assign max_thumbs = 5 %}

  <!-- LEFT COLUMN -->
  <div class="product-gallery">

    <!-- ALWAYS SHOW ALL IMAGES -->
    <div class="product-gallery-side" id="SideThumbs">
      {% for media in product.media %}
        {% if forloop.index0 < max_thumbs %}
          <button 
            type="button" 
            class="product-thumb{% if forloop.first %} is-active{% endif %}"
            data-media-src="{{ media | image_url: width: 1200 }}"
          >
            <img src="{{ media | image_url: width: 120 }}">
          </button>
        {% endif %}
      {% endfor %}

      {% if product.media.size > max_thumbs %}
        <button class="product-thumb product-thumb-more">
          +{{ product.media.size | minus: max_thumbs }}
        </button>
      {% endif %}
    </div>

    <!-- MAIN IMAGE -->
    <div class="product-gallery-main">
      <img 
        id="MainImage"
        class="product-main-image"
        src="{{ initial_variant.featured_media | default: product.media.first | image_url: width: 1200 }}"
        alt="{{ product.title }}"
      >
    </div>

  </div>


  <!-- MIDDLE COLUMN -->
  <div class="product-main-info">

    <h1 class="product-title">{{ product.title }}</h1>
    <div class="product-rating-placeholder">★★★★☆ <span>Rating coming soon</span></div>

    <div class="product-price-main" id="PriceMain">
      {{ initial_variant.price | money }}
    </div>

    {% assign option_count = product.options_with_values.size %}

    <div class="product-selector">

      <!-- COLOR -->
      {% if option_count >= 1 %}
        {% assign color_opt = product.options_with_values[0] %}
        <div class="selector-block">
          <div class="selector-label-row">
            <div class="selector-label">
              Color: <span id="SelectedColor">{{ color_opt.selected_value }}</span>
            </div>
          </div>

          <div class="color-swatch-grid">
            {% for value in color_opt.values %}
              {% assign swatch_img = blank %}
              {% for v in product.variants %}
                {% if v.option1 == value and v.featured_media %}
                  {% assign swatch_img = v.featured_media.preview_image.src %}
                {% endif %}
              {% endfor %}

              <button 
                type="button"
                class="color-swatch{% if color_opt.selected_value == value %} is-active{% endif %}"
                data-option-index="0"
                data-option-value="{{ value }}"
              >
                {% if swatch_img %}
                  <img src="{{ swatch_img | img_url: '120x' }}">
                {% endif %}
                <span>{{ value }}</span>
              </button>

            {% endfor %}
          </div>
        </div>
      {% endif %}

      <!-- SIZE -->
      {% if option_count >= 2 %}
        {% assign size_opt = product.options_with_values[1] %}
        <div class="selector-block">
          <div class="selector-label-row">
            <div class="selector-label">
              Size: <span id="SelectedSize">{{ size_opt.selected_value }}</span>
            </div>
            <button type="button" id="SizeChartButton" class="size-chart-link">Size chart</button>
          </div>

          <div class="size-pill-grid">
            {% for value in size_opt.values %}
              <button 
                type="button"
                class="size-pill{% if size_opt.selected_value == value %} is-active{% endif %}"
                data-option-index="1"
                data-option-value="{{ value }}"
              >
                {{ value }}
              </button>
            {% endfor %}
          </div>

        </div>
      {% endif %}

    </div>

    <!-- PRODUCT DETAILS -->
    <div class="product-details-section">
      <h3>Product details</h3>
      <div class="product-details-content">
        {{ product.description | strip_html }}
      </div>
    </div>

  </div>


  <!-- RIGHT (BUY BOX) -->
  <div class="product-buy-box">

    <div class="buy-box-price" id="BuyBoxPrice">
      {{ initial_variant.price | money }}
    </div>

    <div id="StockBox" class="buy-box-stock">
      {% if initial_variant.available %}In stock{% else %}Out of stock{% endif %}
    </div>

    {% form 'product', product, id: 'ProductForm' %}
      <input type="hidden" name="id" id="VariantIdInput" value="{{ initial_variant.id }}">

      <div class="buy-box-quantity">
        <label>Quantity:</label>
        <select id="QtySelect" name="quantity"></select>
      </div>

      <div class="buy-box-actions">
        <button class="btn btn-primary" type="submit">Add to Cart</button>
        <button class="btn btn-outline" id="BuyNowBtn" type="button">Buy Now</button>
      </div>
    {% endform %}
  </div>

</section>

<!-- FULLSCREEN GALLERY -->
<div class="image-gallery-modal" id="ImageGalleryModal">
  <div class="image-gallery-backdrop"></div>
  <div class="image-gallery-content">
    <button id="ImageGalleryClose" class="image-gallery-close">×</button>
    <div class="image-gallery-carousel" id="ImageGalleryCarousel"></div>
  </div>
</div>

<!-- SIZE CHART -->
<div class="size-chart-modal" id="SizeChartModal">
  <div class="size-chart-backdrop"></div>
  <div class="size-chart-content">
    <button id="SizeChartClose" class="size-chart-close">×</button>
    <h3>Size Chart</h3>
    <div class="size-chart-grid">
      {{ product.metafields.specs.size_chart | metafield_text }}
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {

  const product = {{ product | json }};

  /* ========= SAFE VARIANT SETUP ========= */
  let currentVariant =
    product.selected_or_first_available_variant ||
    product.variants?.[0] ||
    { id: null, price: 0, available: true, options: [] };

  let selectedOptions = Array.isArray(currentVariant.options)
    ? [...currentVariant.options]
    : [];

  const mainImg = document.getElementById("MainImage");

  /* ========= GALLERY ELEMENTS ========= */
  const galleryModal = document.getElementById("ImageGalleryModal");
  const galleryContent = document.getElementById("ImageGalleryCarousel");
  const galleryClose = document.getElementById("ImageGalleryClose");
  const galleryBackdrop = document.querySelector(".image-gallery-backdrop");

  /* ========= SIZE CHART ELEMENTS ========= */
  const sizeModal = document.getElementById("SizeChartModal");
  const sizeBtn = document.getElementById("SizeChartButton");
  const sizeClose = document.getElementById("SizeChartClose");
  const sizeBackdrop = document.querySelector(".size-chart-backdrop");

  /* ========= CLEAN URL HELPER ========= */
  function clean(url) {
    return url ? url.split("?")[0] : "";
  }

  /* ========= SIDE THUMBNAILS CLICK ========= */
  function setupThumbnailClicks() {
    document.querySelectorAll(".product-thumb").forEach(btn => {
      if (btn.classList.contains("product-thumb-more")) {
        btn.onclick = openFullGallery;
        return;
      }

      btn.onclick = () => {
        const src = btn.dataset.mediaSrc;
        mainImg.src = clean(src);

        document.querySelectorAll(".product-thumb")
          .forEach(x => x.classList.remove("is-active"));

        btn.classList.add("is-active");
      };
    });
  }

  setupThumbnailClicks();

  /* ========= FULLSCREEN GALLERY ========= */
  function openFullGallery() {

    galleryContent.innerHTML = "";

    product.media.forEach(m => {
      const img = document.createElement("img");
      img.src = clean(m.src);
      img.className = "gallery-big-image";
      galleryContent.appendChild(img);
    });

    galleryModal.classList.add("is-open");
  }

  if (galleryClose) galleryClose.onclick = () => galleryModal.classList.remove("is-open");
  if (galleryBackdrop) galleryBackdrop.onclick = () => galleryModal.classList.remove("is-open");

  /* ========= COLOR SWITCHING WITH VARIANT UPDATE ========= */
  document.querySelectorAll(".color-swatch").forEach(btn => {
    btn.addEventListener("click", () => {

      const value = btn.dataset.optionValue;

      // UI update
      document.querySelectorAll(".color-swatch").forEach(x => x.classList.remove("is-active"));
      btn.classList.add("is-active");
      document.getElementById("SelectedColor").textContent = value;

      selectedOptions[0] = value;

      // find variant
      let newVariant = product.variants.find(v =>
        JSON.stringify(v.options) === JSON.stringify(selectedOptions)
      );

      if (newVariant) currentVariant = newVariant;

      // update image
      if (currentVariant.featured_media) {
        mainImg.src = clean(currentVariant.featured_media.preview_image.src);
      }
    });
  });

  /* ========= SIZE SWITCHING FIXED ========= */
  document.querySelectorAll(".size-pill").forEach(btn => {
    btn.addEventListener("click", () => {

      const value = btn.dataset.optionValue;

      document.querySelectorAll(".size-pill").forEach(x => x.classList.remove("is-active"));
      btn.classList.add("is-active");

      document.getElementById("SelectedSize").textContent = value;

      selectedOptions[1] = value;

      let newVariant = product.variants.find(v =>
        JSON.stringify(v.options) === JSON.stringify(selectedOptions)
      );

      if (newVariant) currentVariant = newVariant;
    });
  });

  /* ========= SIZE CHART FIXED ========= */
  if (sizeBtn) sizeBtn.onclick = () => sizeModal.classList.add("is-open");
  if (sizeClose) sizeClose.onclick = () => sizeModal.classList.remove("is-open");
  if (sizeBackdrop) sizeBackdrop.onclick = () => sizeModal.classList.remove("is-open");

});
</script>


